<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>المصحف + المعجم</title>
  <style>
    body {
      font-family: 'Amiri', serif;
      background: #fdfcf7;
      margin: 20px;
      font-size: 22px;
      line-height: 2.5;
      color: #222;
    }
    header { margin-bottom: 20px; }
    select { font-size: 18px; padding: 5px 10px; }
    .verse { margin-bottom: 15px; text-align: justify; }
    .ayah-num { color: #666; margin: 0 4px; }
    .word { cursor: pointer; padding: 2px 4px; border-radius: 4px; }
    .word:hover { background: #eef; }
    .tooltip {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      padding: 8px;
      display: none;
      z-index: 1000;
      max-width: 300px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
      font-size: 18px;
    }
  </style>
</head>
<body>

<header>
  <h2>📖 المصحف التفاعلي</h2>
  <select id="suraSelect"></select>
</header>

<div id="quran"></div>
<div id="tooltip" class="tooltip"></div>

<script>
  let dictionary = {};

  // إزالة التشكيل + توحيد الحروف
  function normalize(text) {
    return text
      .replace(/[\u064B-\u065F]/g, "")
      .replace(/إ|أ|آ/g, "ا")
      .replace(/ى/g, "ي")
      .replace(/ؤ/g, "و")
      .replace(/ئ/g, "ي")
      .trim();
  }

  // تحميل المعجم
  async function loadDictionary() {
    const res = await fetch("dictionary.json"); // لازم الملف بجانب index.html
    const raw = await res.json();
    for (const [k,v] of Object.entries(raw)) {
      dictionary[normalize(k)] = v;
    }
  }

  // تحميل قائمة السور
  async function loadSuras() {
    const res = await fetch("https://api.quran.com/api/v4/chapters");
    const data = await res.json();
    const sel = document.getElementById("suraSelect");
    data.chapters.forEach(ch => {
      const opt = document.createElement("option");
      opt.value = ch.id;
      opt.textContent = `${ch.id}. ${ch.name_arabic}`;
      sel.appendChild(opt);
    });
    sel.addEventListener("change", () => {
      loadVerse(sel.value);
    });
  }

  // تحميل سورة
  async function loadVerse(sura) {
    const container = document.getElementById("quran");
    container.innerHTML = "";
    const res = await fetch(`https://api.quran.com/api/v4/verses/by_chapter/${sura}?fields=text_uthmani&words=false`);
    const data = await res.json();
    data.verses.forEach(v => {
      const div = document.createElement("div");
      div.className = "verse";
      v.text_uthmani.split(" ").forEach(w => {
        const span = document.createElement("span");
        span.className = "word";
        span.textContent = w + " ";
        span.addEventListener("click", (event) => {
          showMeaning(w, event);
          event.stopPropagation();
        });
        div.appendChild(span);
      });
      const num = document.createElement("span");
      num.className = "ayah-num";
      num.textContent = ` ﴿${v.verse_number}﴾`;
      div.appendChild(num);
      container.appendChild(div);
    });
  }

  // عرض المعنى
  function showMeaning(word, event) {
    const tooltip = document.getElementById("tooltip");
    const meaning = dictionary[normalize(word)] || "لا يوجد معنى";
    tooltip.textContent = `${word} : ${meaning}`;
    tooltip.style.left = event.pageX + "px";
    tooltip.style.top = event.pageY + "px";
    tooltip.style.display = "block";
  }

  // إخفاء المعنى عند الضغط خارج الكلمة
  document.addEventListener("click", (e) => {
    const tooltip = document.getElementById("tooltip");
    if (!tooltip.contains(e.target) && !e.target.classList.contains("word")) {
      tooltip.style.display = "none";
    }
  });

  // البداية
  loadDictionary().then(() => {
    loadSuras().then(() => {
      loadVerse(1); // يبدأ بالفاتحة
      document.getElementById("suraSelect").value = 1;
    });
  });
</script>

</body>
</html>
